<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Article - Batch 85</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f7fa; color:#333; }
    header { background:#004c80; color:#fff; padding:1rem; text-align:center; position:relative; }
    header a.back-btn { position:absolute; left:15px; top:15%; transform:translateY(-50%); background:#fff; color:#004c80; padding:0.4rem 0.8rem; border-radius:6px; text-decoration:none; font-size:0.9rem; font-weight:bold; transition:background .2s; }
    header a.back-btn:hover { background:#e0e0e0; }
    main { max-width:800px; margin:2rem auto; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    .article-meta { color:#777; font-size:.95rem; margin-bottom:1rem; display:flex; align-items:center; gap:10px; }
    .author-img { width:36px; height:36px; border-radius:50%; object-fit:cover; cursor:zoom-in; }
    .article-body { line-height:1.6; margin-top:1rem; }
    .navigation { display:flex; justify-content:space-between; margin-top:2rem; }
    .nav-btn { background:#004c80; color:#fff; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; font-weight:bold; transition:background .2s; }
    .nav-btn:hover { background:#0060a0; }
    .nav-btn:disabled { background:#ccc; cursor:not-allowed; }
    #articleContent img { max-width:100%; border-radius:8px; margin:10px 0; }
    @media(max-width:600px){ main{padding:1rem} header a.back-btn{left:8px} }

    .comments-section {
  margin-top: 2rem;
  border-top: 1px solid #ddd;
  padding-top: 1rem;
}

.comments-section h3 {
  color: #004c80;
}

.comments-section textarea {
  width: 100%;
  padding: 0.6rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  resize: none;
  margin-bottom: 0.5rem;
}

.comments-section button {
  background: #004c80;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 0.6rem 1rem;
  cursor: pointer;
}

.comments-section button:hover {
  background: #0066aa;
}

.comment {
  background: #f0f5fa;
  padding: 0.7rem;
  border-radius: 6px;
  margin-top: 0.5rem;
}

  </style>
</head>
<body>
  <header>
    <a href="articles.html" class="back-btn">‚Üê Back to Articles</a>
    <h1 id="articleTitle">Loading...</h1>
  </header>

  <main>
    <div class="article-meta">
      <img id="authorImg" class="author-img" src="Images/default.jpg" alt="Author">
      <span id="articleAuthor">by Elijah</span>
    </div>

    <article id="articleContent">Loading article...</article>

    <div class="navigation">
      <button id="prevBtn" class="nav-btn">‚Üê Previous</button>
      <button id="nextBtn" class="nav-btn">Next ‚Üí</button>
    </div>
    <!-- üí¨ Comment Section -->
<div class="comments-section">
  <h3>Comments</h3>
  <div id="comments"></div>
  <textarea id="commentInput" placeholder="Write a comment..."></textarea>
  <button id="postComment">Post</button>
</div>

<script>
  // üí¨ Local comment system
  const commentsContainer = document.getElementById('comments');
  const postButton = document.getElementById('postComment');
  const commentInput = document.getElementById('commentInput');
  const articleId = window.location.pathname; // unique per article

  function loadComments() {
    const saved = localStorage.getItem('comments_' + articleId);
    commentsContainer.innerHTML = '';
    if (saved) {
      const comments = JSON.parse(saved);
      comments.forEach(text => {
        const div = document.createElement('div');
        div.className = 'comment';
        div.textContent = text;
        commentsContainer.appendChild(div);
      });
    }
  }

  postButton.addEventListener('click', () => {
    const text = commentInput.value.trim();
    if (!text) return;
    const saved = JSON.parse(localStorage.getItem('comments_' + articleId) || '[]');
    saved.push(text);
    localStorage.setItem('comments_' + articleId, JSON.stringify(saved));
    commentInput.value = '';
    loadComments();
  });

  loadComments();
</script>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
  const repoOwner = "d69barrion-web";
  const repoName = "Batch-85-";
  const basePath = "Articles";

  const titleEl = document.getElementById("articleTitle");
  const contentEl = document.getElementById("articleContent");
  const authorEl = document.getElementById("articleAuthor");
  const authorImgEl = document.getElementById("authorImg");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  const params = new URLSearchParams(window.location.search);
  const folderName = params.get("folder");
  let fileIndex = parseInt(params.get("index")) || 0;

  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
    return r.json();
  }

  async function existsHead(url) {
    try {
      const r = await fetch(url, { method: "HEAD" });
      return r.ok;
    } catch {
      return false;
    }
  }

  function authorFileBase(name) {
    return name
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  async function findAuthorImage(penName) {
    const exts = [".jpg", ".jpeg", ".png"];
    const base = authorFileBase(penName);

    for (const ext of exts) {
      const candidate = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/Images/Authors/${base}${ext}`;
      if (await existsHead(candidate)) return candidate;
    }
    return `Images/default.jpg`;
  }

  async function loadArticle() {
    try {
      if (!folderName) throw new Error("No folder specified in the URL.");

      const folderApi = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${basePath}/${encodeURIComponent(folderName)}`;
      const files = await fetchJSON(folderApi);
      const mdFiles = files.filter(f => f.name.toLowerCase().endsWith(".md")).sort((a,b)=>a.name.localeCompare(b.name));
      if (!mdFiles.length) throw new Error("No markdown files found in this folder.");

      if (fileIndex < 0) fileIndex = 0;
      if (fileIndex >= mdFiles.length) fileIndex = mdFiles.length - 1;

      const currentFile = mdFiles[fileIndex];
      const rawUrl = currentFile.download_url;
      const fileText = await (await fetch(rawUrl)).text();

      const fmMatch = fileText.match(/^---\s*([\s\S]*?)\s*---/);
      let metadata = {};
      let body = fileText;
      if (fmMatch) {
        const fm = fmMatch[1].trim();
        body = fileText.replace(fmMatch[0], "").trim();
        fm.split(/\r?\n/).forEach(line => {
          const [k, ...rest] = line.split(":");
          if (!k) return;
          const key = k.trim().toLowerCase();
          const val = rest.join(":").trim();
          metadata[key] = val;
        });
      }

      const displayTitle = metadata["title"] || currentFile.name.replace(/\.md$/i,"").replace(/[-_]/g," ");
      const penName = metadata["pen name"] || metadata["author"] || metadata["penname"] || "Elijah";
      authorEl.textContent = `by ${penName}`;
      titleEl.textContent = displayTitle;

      let chosenImg = null;

      // RULE 1: If front matter has image
      if (metadata["image"]) {
        const candidate = `Images/Articles/${metadata["image"]}`;
        const rawCandidate = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${candidate}`;
        if (await existsHead(rawCandidate)) {
          chosenImg = rawCandidate;
        }
      }

      // RULE 2: If no valid front-matter image, try Authors folder
      if (!chosenImg) {
        chosenImg = await findAuthorImage(penName);
      }

      // RULE 3: Fallback to default
      authorImgEl.src = chosenImg.startsWith("http") ? chosenImg : `/${chosenImg}`;
      authorImgEl.onerror = () => { authorImgEl.src = '/Images/default.jpg'; };

      contentEl.innerHTML = marked.parse(body);

      // Navigation logic
      const articlesApi = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${basePath}`;
      const folders = await fetchJSON(articlesApi);
      const subfolders = folders.filter(f => f.type === "dir").map(f => f.name);
      const currentFolderIndex = subfolders.indexOf(folderName);

      const multiplePages = mdFiles.length > 1;
      const multipleFolders = subfolders.length > 1;

      if (multiplePages) {
        prevBtn.style.display = "inline-block";
        nextBtn.style.display = "inline-block";
        prevBtn.disabled = fileIndex === 0;
        nextBtn.disabled = fileIndex === mdFiles.length - 1;
        prevBtn.textContent = "‚Üê Previous Page";
        nextBtn.textContent = "Next Page ‚Üí";

        prevBtn.onclick = () => {
          if (fileIndex > 0)
            window.location.href = `article.html?folder=${encodeURIComponent(folderName)}&index=${fileIndex-1}`;
        };
        nextBtn.onclick = () => {
          if (fileIndex < mdFiles.length-1)
            window.location.href = `article.html?folder=${encodeURIComponent(folderName)}&index=${fileIndex+1}`;
        };
      } else if (multipleFolders) {
        const prevFolder = subfolders[currentFolderIndex - 1] || null;
        const nextFolder = subfolders[currentFolderIndex + 1] || null;

        prevBtn.style.display = prevFolder ? "inline-block" : "none";
        nextBtn.style.display = nextFolder ? "inline-block" : "none";
        prevBtn.textContent = "‚Üê Previous Article";
        nextBtn.textContent = "Next Article ‚Üí";

        prevBtn.onclick = () => {
          if (prevFolder) window.location.href = `article.html?folder=${encodeURIComponent(prevFolder)}&index=0`;
        };
        nextBtn.onclick = () => {
          if (nextFolder) window.location.href = `article.html?folder=${encodeURIComponent(nextFolder)}&index=0`;
        };
      } else {
        prevBtn.style.display = "none";
        nextBtn.style.display = "none";
      }

    } catch (err) {
      titleEl.textContent = "Error";
      contentEl.innerHTML = `<p style="color:red;">${err.message}</p>`;
      prevBtn.style.display = "none";
      nextBtn.style.display = "none";
      console.error(err);
    }
  }

  loadArticle();
  </script>
</body>
</html>
