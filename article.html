<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Article - Batch 85</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f7fa; color:#333; }
    header { background:#004c80; color:#fff; padding:1rem; text-align:center; position:relative; }
    header a.back-btn { position:absolute; left:15px; top:15%; transform:translateY(-50%); background:#fff; color:#004c80; padding:0.4rem 0.8rem; border-radius:6px; text-decoration:none; font-size:0.9rem; font-weight:bold; transition:background .2s; }
    header a.back-btn:hover { background:#e0e0e0; }
    main { max-width:800px; margin:2rem auto; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    .article-meta { color:#777; font-size:.95rem; margin-bottom:1rem; display:flex; align-items:center; gap:10px; }
    .author-img { width:36px; height:36px; border-radius:50%; object-fit:cover; cursor:zoom-in; }
    .article-body { line-height:1.6; margin-top:1rem; }
    .navigation { display:flex; justify-content:space-between; margin-top:2rem; }
    .nav-btn { background:#004c80; color:#fff; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; font-weight:bold; transition:background .2s; }
    .nav-btn:hover { background:#0060a0; }
    .nav-btn:disabled { background:#ccc; cursor:not-allowed; }
    #articleContent img { max-width:100%; border-radius:8px; margin:10px 0; }
    @media(max-width:600px){ main{padding:1rem} header a.back-btn{left:8px} }

    /* üí¨ Comment section styles */
    .comments-section { margin-top: 2rem; border-top: 1px solid #ddd; padding-top: 1rem; }
    .comments-section h3 { color: #004c80; }
    textarea { width:100%; padding:0.6rem; border:1px solid #ccc; border-radius:6px; resize:none; margin-bottom:0.5rem; }
    button.comment-btn { background:#004c80; color:#fff; border:none; border-radius:6px; padding:0.6rem 1rem; cursor:pointer; }
    button.comment-btn:hover { background:#0066aa; }
    .comment { background:#f0f5fa; padding:0.7rem; border-radius:6px; margin-top:0.7rem; }
    .comment-actions { margin-top:0.4rem; }
    .reply-box { margin-top:0.5rem; margin-left:1rem; }
    .reply { background:#e9f1f9; padding:0.5rem; border-radius:6px; margin:0.4rem 0 0.4rem 1rem; }
    .vote-btn { background:none; border:none; font-size:1.1rem; cursor:pointer; color:#004c80; }
    .vote-btn:hover { color:#0066aa; }
  </style>
</head>
<body>
  <header>
    <a href="articles.html" class="back-btn">‚Üê Back to Articles</a>
    <h1 id="articleTitle">Loading...</h1>
  </header>

  <main>
    <div class="article-meta">
      <img id="authorImg" class="author-img" src="Images/default.jpg" alt="Author">
      <span id="articleAuthor">by Elijah</span>
    </div>

    <article id="articleContent">Loading article...</article>

    <div class="navigation">
      <button id="prevBtn" class="nav-btn">‚Üê Previous</button>
      <button id="nextBtn" class="nav-btn">Next ‚Üí</button>
    </div>

    <!-- üí¨ Firebase Comment Section -->
    <div class="comments-section">
      <h3>Comments</h3>
      <div id="comments"></div>
      <textarea id="commentInput" placeholder="Write a comment..."></textarea>
      <button id="postComment" class="comment-btn">Post</button>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- üî• Modular Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiOFSX-48aBDM_Vi1OkEm_rHlUQCcuVAQ",
      authDomain: "batch-85.firebaseapp.com",
      projectId: "batch-85",
      storageBucket: "batch-85.firebasestorage.app",
      messagingSenderId: "1028686567075",
      appId: "1:1028686567075:web:32076ce1ab73d6d829d116",
      measurementId: "G-SVF7KLCEDB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const repoOwner = "d69barrion-web";
    const repoName = "Batch-85-";
    const basePath = "Articles";

    const titleEl = document.getElementById("articleTitle");
    const contentEl = document.getElementById("articleContent");
    const authorEl = document.getElementById("articleAuthor");
    const authorImgEl = document.getElementById("authorImg");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const params = new URLSearchParams(window.location.search);
    const folderName = params.get("folder");
    let fileIndex = parseInt(params.get("index")) || 0;

    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      return r.json();
    }

    async function existsHead(url) {
      try {
        const r = await fetch(url, { method: "HEAD" });
        return r.ok;
      } catch {
        return false;
      }
    }

    function authorFileBase(name) {
      return name.toLowerCase().trim().replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
    }

    async function findAuthorImage(penName) {
      const exts = [".jpg", ".jpeg", ".png"];
      const base = authorFileBase(penName);
      for (const ext of exts) {
        const candidate = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/Images/Authors/${base}${ext}`;
        if (await existsHead(candidate)) return candidate;
      }
      return `Images/default.jpg`;
    }

    async function loadArticle() {
      try {
        if (!folderName) throw new Error("No folder specified in the URL.");

        const folderApi = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${basePath}/${encodeURIComponent(folderName)}`;
        const files = await fetchJSON(folderApi);
        const mdFiles = files.filter(f => f.name.toLowerCase().endsWith(".md")).sort((a,b)=>a.name.localeCompare(b.name));
        if (!mdFiles.length) throw new Error("No markdown files found in this folder.");

        if (fileIndex < 0) fileIndex = 0;
        if (fileIndex >= mdFiles.length) fileIndex = mdFiles.length - 1;

        const currentFile = mdFiles[fileIndex];
        const rawUrl = currentFile.download_url;
        const fileText = await (await fetch(rawUrl)).text();

        const fmMatch = fileText.match(/^---\s*([\s\S]*?)\s*---/);
        let metadata = {};
        let body = fileText;
        if (fmMatch) {
          const fm = fmMatch[1].trim();
          body = fileText.replace(fmMatch[0], "").trim();
          fm.split(/\r?\n/).forEach(line => {
            const [k, ...rest] = line.split(":");
            if (!k) return;
            const key = k.trim().toLowerCase();
            const val = rest.join(":").trim();
            metadata[key] = val;
          });
        }

        const displayTitle = metadata["title"] || currentFile.name.replace(/\.md$/i,"").replace(/[-_]/g," ");
        const penName = metadata["pen name"] || metadata["author"] || metadata["penname"] || "Elijah";
        authorEl.textContent = `by ${penName}`;
        titleEl.textContent = displayTitle;

        let chosenImg = null;
        if (metadata["image"]) {
          const candidate = `Images/Articles/${metadata["image"]}`;
          const rawCandidate = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${candidate}`;
          if (await existsHead(rawCandidate)) chosenImg = rawCandidate;
        }
        if (!chosenImg) chosenImg = await findAuthorImage(penName);
        authorImgEl.src = chosenImg.startsWith("http") ? chosenImg : `/${chosenImg}`;
        authorImgEl.onerror = () => { authorImgEl.src = '/Images/default.jpg'; };

        contentEl.innerHTML = marked.parse(body);

        // Navigation setup
        const articlesApi = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${basePath}`;
        const folders = await fetchJSON(articlesApi);
        const subfolders = folders.filter(f => f.type === "dir").map(f => f.name);
        const currentFolderIndex = subfolders.indexOf(folderName);
        const multiplePages = mdFiles.length > 1;
        const multipleFolders = subfolders.length > 1;

        if (multiplePages) {
          prevBtn.style.display = "inline-block";
          nextBtn.style.display = "inline-block";
          prevBtn.disabled = fileIndex === 0;
          nextBtn.disabled = fileIndex === mdFiles.length - 1;
          prevBtn.textContent = "‚Üê Previous Page";
          nextBtn.textContent = "Next Page ‚Üí";
          prevBtn.onclick = () => {
            if (fileIndex > 0)
              window.location.href = `article.html?folder=${encodeURIComponent(folderName)}&index=${fileIndex-1}`;
          };
          nextBtn.onclick = () => {
            if (fileIndex < mdFiles.length-1)
              window.location.href = `article.html?folder=${encodeURIComponent(folderName)}&index=${fileIndex+1}`;
          };
        } else if (multipleFolders) {
          const prevFolder = subfolders[currentFolderIndex - 1] || null;
          const nextFolder = subfolders[currentFolderIndex + 1] || null;
          prevBtn.style.display = prevFolder ? "inline-block" : "none";
          nextBtn.style.display = nextFolder ? "inline-block" : "none";
          prevBtn.textContent = "‚Üê Previous Article";
          nextBtn.textContent = "Next Article ‚Üí";
          prevBtn.onclick = () => {
            if (prevFolder) window.location.href = `article.html?folder=${encodeURIComponent(prevFolder)}&index=0`;
          };
          nextBtn.onclick = () => {
            if (nextFolder) window.location.href = `article.html?folder=${encodeURIComponent(nextFolder)}&index=0`;
          };
        } else {
          prevBtn.style.display = "none";
          nextBtn.style.display = "none";
        }

        // ‚úÖ Initialize Firebase comments
        initComments();

      } catch (err) {
        titleEl.textContent = "Error";
        contentEl.innerHTML = `<p style="color:red;">${err.message}</p>`;
        prevBtn.style.display = "none";
        nextBtn.style.display = "none";
        console.error(err);
      }
    }

    // --------------------------
    // üí¨ Firebase Comment System (modular v10)
    // --------------------------
    function initComments() {
      const commentsContainer = document.getElementById('comments');
      const postButton = document.getElementById('postComment');
      const commentInput = document.getElementById('commentInput');
      const articleId = folderName + "_" + fileIndex;
      const commentsRef = ref(db, 'comments/' + articleId);

      // Listen for comment updates
      onValue(commentsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const comments = Object.entries(data).map(([id, comment]) => ({ id, ...comment }));
        renderComments(comments);
      });

      postButton.onclick = () => {
        const text = commentInput.value.trim();
        if (!text) return;
        push(commentsRef, { text, votes: 0, replies: [] });
        commentInput.value = '';
      };

      function renderComments(comments) {
        commentsContainer.innerHTML = '';
        comments.forEach(comment => {
          const div = document.createElement('div');
          div.className = 'comment';
          div.innerHTML = `
            <p>${comment.text}</p>
            <div class="comment-actions">
              <button class="vote-btn upvote">‚¨ÜÔ∏è</button>
              <span>${comment.votes || 0}</span>
              <button class="vote-btn downvote">‚¨áÔ∏è</button>
              <button class="reply-btn">Reply</button>
              <button class="delete-btn">Delete</button>
            </div>
          `;

          // Votes
          div.querySelector('.upvote').onclick = () => {
            update(ref(db, 'comments/' + articleId + '/' + comment.id), { votes: (comment.votes || 0) + 1 });
          };
          div.querySelector('.downvote').onclick = () => {
            update(ref(db, 'comments/' + articleId + '/' + comment.id), { votes: (comment.votes || 0) - 1 });
          };

          // Delete
          div.querySelector('.delete-btn').onclick = () => {
            remove(ref(db, 'comments/' + articleId + '/' + comment.id));
          };

          // Reply
          div.querySelector('.reply-btn').onclick = () => {
            const replyBox = document.createElement('div');
            replyBox.className = 'reply-box';
            replyBox.innerHTML = `
              <textarea rows="2" placeholder="Write a reply..."></textarea>
              <button class="comment-btn">Post Reply</button>
            `;
            replyBox.querySelector('button').onclick = () => {
              const txt = replyBox.querySelector('textarea').value.trim();
              if (!txt) return;
              const replies = comment.replies || [];
              replies.push({ text: txt, votes: 0 });
              update(ref(db, 'comments/' + articleId + '/' + comment.id), { replies });
            };
            div.appendChild(replyBox);
          };

          // Show replies
          if (comment.replies && comment.replies.length > 0) {
            const repliesDiv = document.createElement('div');
            repliesDiv.className = 'replies-container';
            comment.replies.forEach(reply => {
              const rep = document.createElement('div');
              rep.className = 'reply';
              rep.innerHTML = `<p>${reply.text}</p>`;
              repliesDiv.appendChild(rep);
            });
            div.appendChild(repliesDiv);
          }

          commentsContainer.appendChild(div);
        });
      }
    }

    // Load the article
    loadArticle();
  </script>
</body>
</html>
