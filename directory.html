<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Batch 85 Directory</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f7fa; color:#333; }
    header { background:#004c80; color:#fff; text-align:center; padding:1rem; }
    header h1 { margin:0; font-size:1.6rem; }

    main { max-width:900px; margin:2rem auto; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,.1); }

    #userPanel { display:flex; align-items:center; gap:10px; justify-content:flex-end; margin-bottom:20px; }
    #userPanel img { width:32px; height:32px; border-radius:50%; }
    #loginBtn, #logoutBtn { background:#004c80; color:#fff; border:none; border-radius:6px; padding:0.4rem 0.8rem; cursor:pointer; font-weight:bold; }
    #loginBtn:hover, #logoutBtn:hover { background:#0066aa; }

    .join-section { text-align:center; border-top:1px solid #ddd; margin-top:2rem; padding-top:1.5rem; }
    .join-section button { background:#004c80; color:#fff; border:none; padding:0.6rem 1rem; border-radius:8px; cursor:pointer; font-weight:bold; }
    .join-section button:hover { background:#0060a0; }

    .directory-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:1rem; margin-top:1rem; }
    .member-card { background:#f0f5fa; border-radius:10px; padding:1rem; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    .member-card img { width:80px; height:80px; border-radius:50%; object-fit:cover; margin-bottom:0.5rem; }
    .member-card h4 { margin:0.3rem 0; font-size:1rem; color:#004c80; }
    .member-card p { font-size:0.85rem; color:#666; word-wrap:break-word; }

    /* Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:1.5rem; border-radius:10px; width:90%; max-width:400px; text-align:center; }
    .modal-content input { width:100%; padding:0.5rem; margin:0.4rem 0; border:1px solid #ccc; border-radius:6px; }
    .modal-content button { margin-top:0.6rem; background:#004c80; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:8px; cursor:pointer; font-weight:bold; }
    .modal-content button:hover { background:#0066aa; }
  </style>
</head>
<body>
  <header><h1>Batch 85 Directory</h1></header>

  <main>
    <!-- 🔐 Auth panel -->
    <div id="userPanel">
      <img id="userPhoto" src="Images/default.jpg" alt="User" style="display:none;">
      <span id="userName"></span>
      <button id="loginBtn">Sign in with Google</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>

    <h2>📸 Our Batchmates</h2>
    <div id="directoryList" class="directory-grid"></div>

    <div class="join-section">
      <p>Not yet listed? Join the Batch 85 Directory!</p>
      <button id="joinBtn">Join Directory</button>
    </div>
  </main>

  <!-- 🪟 Join modal -->
  <div id="joinModal" class="modal">
    <div class="modal-content">
      <h3>Join the Directory</h3>
      <input type="text" id="fullName" placeholder="Full Name" required />
      <input type="text" id="skillWork" placeholder="Skill/Work" required />
      <input type="text" id="location" placeholder="Location" required />
      <input type="file" id="photoInput" accept="image/*" />
      <button id="saveProfile">Save</button>
    </div>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBiOFSX-48aBDM_Vi1OkEm_rHlUQCcuVAQ",
  authDomain: "batch-85.firebaseapp.com",
  databaseURL: "https://batch-85-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "batch-85",
  storageBucket: "batch-85.appspot.com", // ✅ corrected
  messagingSenderId: "1028686567075",
  appId: "1:1028686567075:web:32076ce1ab73d6d829d116"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const storage = getStorage(app);

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userName = document.getElementById("userName");
const userPhoto = document.getElementById("userPhoto");
const joinBtn = document.getElementById("joinBtn");
const modal = document.getElementById("joinModal");
const saveProfileBtn = document.getElementById("saveProfile");
const fullNameInput = document.getElementById("fullName");
const skillWorkInput = document.getElementById("skillWork");
const locationInput = document.getElementById("location");
const photoInput = document.getElementById("photoInput");
const directoryList = document.getElementById("directoryList");

// 🔐 Auth system
loginBtn.onclick = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  if (user) {
    userName.textContent = user.displayName;
    userPhoto.src = user.photoURL;
    userPhoto.style.display = "inline-block";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";

    // ✅ Check if user is already in the directory
    const userRef = ref(db, "directory/" + user.uid);
    onValue(userRef, (snapshot) => {
      const exists = snapshot.exists();
      joinBtn.style.display = exists ? "none" : "inline-block";
    }, { onlyOnce: true });

  } else {
    userName.textContent = "";
    userPhoto.style.display = "none";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    joinBtn.style.display = "inline-block"; // show join button only if logged out
  }
});

// 📋 Load directory realtime
const dirRef = ref(db, "directory");
let selectedUid = null;
let deleteBtn = null;

onValue(dirRef, (snapshot) => {
  const data = snapshot.val() || {};
  directoryList.innerHTML = "";
  selectedUid = null;
  if (deleteBtn) deleteBtn.remove();

  Object.entries(data).forEach(([uid, member]) => {
    const div = document.createElement("div");
    div.className = "member-card";
    div.innerHTML = `
      <img src="${member.photoURL || 'Images/default.jpg'}" alt="photo" />
      <h4>${member.name || "Anonymous"}</h4>
      <h2>${member.skillWork ||"Secret"}</h2>
      <p>${member.location ||"undisclosed"}</p>
      <p>${member.email || ""}</p>
    `;

    // 🔹 Kapag tinap ang card
    div.onclick = () => {
      // Toggle selection
      if (selectedUid === uid) {
        div.style.outline = "none";
        selectedUid = null;
        if (deleteBtn) deleteBtn.remove();
      } else {
        // Alisin highlight sa iba
        document.querySelectorAll(".member-card").forEach(card => card.style.outline = "none");
        div.style.outline = "3px solid #004c80";
        selectedUid = uid;

        // Gumawa ng delete button kung wala pa
        if (!deleteBtn) {
          deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.style.cssText = `
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #c0392b;
            color: #fff;
            border: none;
            padding: 0.8rem 1.4rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,.2);
          `;
          deleteBtn.onclick = async () => {
            const current = auth.currentUser;
            if (!current) return alert("Please sign in first.");
            const member = data[selectedUid];
            if (member.email !== current.email) return alert("You can only delete your own record.");
            if (!confirm(`Are you sure you want to delete ${member.name}?`)) return;
            await remove(ref(db, "directory/" + selectedUid));
            alert(`${member.name} deleted.`);
            selectedUid = null;
            deleteBtn.remove();
          };
          document.body.appendChild(deleteBtn);
        }
      }
    };

    directoryList.appendChild(div);
  });
});

// 🪟 Join modal control
joinBtn.onclick = () => {
  if (!auth.currentUser) return alert("Please sign in with Google first.");
  modal.style.display = "flex";
};
modal.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

// 💾 Save profile
saveProfileBtn.onclick = async () => {
  const user = auth.currentUser;
  if (!user) return alert("Please sign in first.");
  const name = fullNameInput.value.trim() || user.displayName;
  const skillWork = skillWorkInput.value.trim() || user.displayWork;
  const location = locationInput.value.trim() || user.displayLocation;
  let photoURL = user.photoURL;

  // Upload custom photo if selected
  const file = photoInput.files[0];
  if (file) {
    const { ref: sRef, uploadBytes, getDownloadURL } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js");
    const storageRef = sRef(storage, `directory/${user.uid}/${file.name}`);
    await uploadBytes(storageRef, file);
    photoURL = await getDownloadURL(storageRef);
  }

  await set(ref(db, "directory/" + user.uid), {
    name, skillWork, location,
    email: user.email,
    photoURL
  });

  modal.style.display = "none";
  fullNameInput.value = "";
  photoInput.value = "";
};
</script>

</body>
</html>